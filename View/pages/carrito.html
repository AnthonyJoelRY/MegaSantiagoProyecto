<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MegaSantiago | Carrito</title>

    <!-- CSS (desde View/pages → Model) -->
    <link rel="stylesheet" href="../../Model/csss estilos/estilos.css">
</head>
<body>

    <!-- ===== LAYOUT ===== -->
    <div id="header"></div>
    <!-- ================== -->

    <!-- CONTENIDO CARRITO -->
    <main class="cart-page">
        <section class="cart-container">

            <h2>Resumen de tu carrito</h2>

            <div id="cart-vacio" class="cart-vacio">
                Tu carrito está vacío. Agrega productos desde la página principal.
            </div>

            <div id="cart-contenido" class="cart-contenido">
                <table class="cart-tabla">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Precio unit.</th>
                            <th>Cantidad</th>
                            <th>Subtotal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="tbodyCarrito">
                        <!-- filas generadas por JS -->
                    </tbody>
                </table>

                <div class="cart-footer">
                    <button id="btnVaciar" class="btn-cart-secondary">Vaciar carrito</button>

                    <div class="cart-total">
                        <span>Total:</span>
                        <strong id="totalCarrito">$0.00</strong>
                    </div>
                </div>

                <button class="btn-cart-primary">
                    Finalizar compra (demo)
                </button>
            </div>

        </section>
    </main>

    <!-- ===== FOOTER ===== -->
    <div id="footer"></div>
    <div id="scripts"></div>
    <!-- ================== -->

    <script>
        // ----- LÓGICA DEL CARRITO EN LA PÁGINA CARRITO -----
        function obtenerCarrito() {
            return JSON.parse(localStorage.getItem('carritoMega') || '[]');
        }

        function guardarCarrito(carrito) {
            localStorage.setItem('carritoMega', JSON.stringify(carrito));
        }

        function formatearDinero(valor) {
            return '$' + Number(valor).toFixed(2);
        }

        function renderCarrito() {
            const tbody = document.getElementById('tbodyCarrito');
            const divVacio = document.getElementById('cart-vacio');
            const divContenido = document.getElementById('cart-contenido');
            const spanTotal = document.getElementById('totalCarrito');

            const carrito = obtenerCarrito();
            tbody.innerHTML = '';

            if (carrito.length === 0) {
                divVacio.style.display = 'block';
                divContenido.style.display = 'none';
                spanTotal.textContent = '$0.00';
                return;
            }

            divVacio.style.display = 'none';
            divContenido.style.display = 'block';

            let total = 0;

            carrito.forEach(item => {
                const subtotal = item.precio * item.cantidad;
                total += subtotal;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.nombre}</td>
                    <td>${formatearDinero(item.precio)}</td>
                    <td>
                        <input type="number" min="1" value="${item.cantidad}"
                               class="cart-cantidad" data-id="${item.id}">
                    </td>
                    <td>${formatearDinero(subtotal)}</td>
                    <td>
                        <button class="btn-cart-delete" data-id="${item.id}">✕</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            spanTotal.textContent = formatearDinero(total);
        }

        // Cambiar cantidad
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('cart-cantidad')) {
                const id = e.target.getAttribute('data-id');
                let nuevaCantidad = parseInt(e.target.value, 10);
                if (isNaN(nuevaCantidad) || nuevaCantidad < 1) nuevaCantidad = 1;
                e.target.value = nuevaCantidad;

                const carrito = obtenerCarrito();
                const item = carrito.find(p => p.id === id);
                if (item) {
                    item.cantidad = nuevaCantidad;
                    guardarCarrito(carrito);
                    renderCarrito();
                }
            }
        });

        // Eliminar producto
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-cart-delete')) {
                const id = e.target.getAttribute('data-id');
                let carrito = obtenerCarrito();
                carrito = carrito.filter(p => p.id !== id);
                guardarCarrito(carrito);
                renderCarrito();
            }
        });

        // Vaciar carrito (ahora espera al DOM + plantilla)
        function initCarritoPage() {
            const btnVaciar = document.getElementById('btnVaciar');
            if (btnVaciar) {
                btnVaciar.addEventListener('click', function() {
                    if (confirm('¿Seguro que quieres vaciar el carrito?')) {
                        localStorage.removeItem('carritoMega');
                        renderCarrito();
                    }
                });
            }
            renderCarrito();
        }

        /* ===== ALIAS BUSCADOR (OPCIÓN 1) ===== */
        function realizarBusquedaGlobal() {
            const input = document.getElementById("buscador");
            if (!input) return;
            const q = input.value.trim();
            if (!q) return;
            window.location.href = "busqueda.html?q=" + encodeURIComponent(q);
        }
    </script>

    <!-- ===== LAYOUT LOADER ===== -->
    <script src="../js/layout-loader.js"></script>
    <script>
        // Cargar plantilla y luego iniciar carrito (por si el layout mete scripts o header)
        loadLayout().then(() => {
            initCarritoPage();
        });
    </script>

</body>
</html>
