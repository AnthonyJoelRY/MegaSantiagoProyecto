<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta 
  name="viewport" 
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>

  <title>MegaSantiago | Inicio</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">


  <link rel="stylesheet" href="/View/assets/css/estilos.css" />
  <link rel="stylesheet" href="/View/assets/css/overrides.css">
  <link rel="stylesheet" href="/View/assets/css/footer.css">
</head>

  <body>
    <!-- ===== LAYOUT ===== -->
    <div id="header"></div>
    <div id="nav"></div>
    <!-- ================== -->

<div class="promo-wrapper">
  <!-- Carrusel -->
  <div id="promoPreview" class="promo-preview">
    <img id="promoPrev" class="promo-img side" />
    <img id="promoActive" class="promo-img active" />
    <img id="promoNext" class="promo-img side" />
  </div>

  <!-- Flechas -->
<button id="promoPrevBtn" class="promo-arrow prev"></button>
<button id="promoNextBtn" class="promo-arrow next"></button>
</div>

<!-- Dots -->
<div id="promoDots" class="promo-dots"></div>


<section class="seccion">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h2 class="fw-bold mb-0">
      Productos m√°s vendidos
    </h2>
    <div class="flex-grow-1 ms-3 border-bottom"></div>
  </div>

  <div id="gridMasVendidos" class="row g-4"></div>
</section>


<section class="seccion">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h2 class="fw-bold mb-0">
      Explora nuestras categor√≠as
    </h2>
    <div class="flex-grow-1 ms-3 border-bottom"></div>
  </div>

  <div class="categorias-horizontal">

    <a href="View/pages/bazar.html" class="categoria-img">
      <img src="https://firebasestorage.googleapis.com/v0/b/megasantiago.firebasestorage.app/o/productos%2FBazar.png?alt=media&token=058f8c1c-f819-41ba-a73e-3cb1d68bea9b">
    </a>

    <a href="View/pages/papeleria.html" class="categoria-img">
      <img src="https://firebasestorage.googleapis.com/v0/b/megasantiago.firebasestorage.app/o/productos%2Fpapeleria.png?alt=media&token=861b239d-2abf-4b0d-aaeb-7b73398a27d0">
    </a>

    <a href="View/pages/productos-arte.html" class="categoria-img">
      <img src="https://firebasestorage.googleapis.com/v0/b/megasantiago.firebasestorage.app/o/productos%2Farte.png?alt=media&token=a4aef73e-1164-4d00-b8d6-9d82b94e2f77">
    </a>

    <a href="View/pages/suministros-oficina.html" class="categoria-img">
      <img src="https://firebasestorage.googleapis.com/v0/b/megasantiago.firebasestorage.app/o/productos%2Foficina.png?alt=media&token=c6b45737-1bce-4845-85bd-989a95f523a9">
    </a>

    <a href="View/pages/utiles-escolares.html" class="categoria-img">
      <img src="https://firebasestorage.googleapis.com/v0/b/megasantiago.firebasestorage.app/o/productos%2FutilesEscolares.png?alt=media&token=6f4cb403-0ecf-4548-813e-156f270ec88e" alt="√ötiles escolares">
    </a>

  </div>
</section>

      
      
<section id="promociones" class="seccion">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h2 class="fw-bold mb-0">Ofertas MegaSantiago</h2>
    <div class="flex-grow-1 ms-3 border-bottom"></div>
  </div>

  <div class="container">
    <div class="ofertas-carrusel-frame position-relative">

      <!-- Flechas IGUALES al banner -->
      <button id="ofertasPrevBtn" class="promo-arrow prev"></button>
      <button id="ofertasNextBtn" class="promo-arrow next"></button>

      <div class="ofertas-carrusel-wrapper">
        <div id="gridPromos" class="ofertas-carrusel row g-4"></div>
      </div>

      <!-- Dots -->
      <div class="promo-dots" id="ofertasDots"></div>

    </div>
  </div>
</section>







    <!-- ===== FOOTER ===== -->
    <div id="footer"></div>
    <div id="scripts"></div>
    <!-- ================== -->

    <script>
let carruselOfertasActivo = false;

let promocionesCargadas = false;


      const API_URL = "/Controller/productosController.php";
        const API_REPORTES = "/Controller/reportesController.php";


      function resolverImagen(img) {
        if (!img || String(img).trim() === "") return "/Model/imagenes/sin-imagen.png";
        const limpia = String(img).trim();
        if (limpia.startsWith("http://") || limpia.startsWith("https://")) return limpia;
        return "/Model/" + limpia;
      }

      function formatearDinero(valor) {
        return "$" + Number(valor).toFixed(2);
      }

      function obtenerCarrito() {
        return JSON.parse(localStorage.getItem("carritoMega") || "[]");
      }

      function guardarCarrito(carrito) {
        localStorage.setItem("carritoMega", JSON.stringify(carrito));
                try { window.dispatchEvent(new Event("carrito_actualizado")); } catch(e) {}
                if (typeof actualizarContadorCarrito === "function") actualizarContadorCarrito();
try { window.dispatchEvent(new Event("carrito_actualizado")); } catch(e) {}
        if (typeof actualizarContadorCarrito === "function") actualizarContadorCarrito();
try { window.dispatchEvent(new Event("carrito_actualizado")); } catch(e) {}
        if (typeof actualizarContadorCarrito === "function") actualizarContadorCarrito();
}

      function agregarAlCarrito(id, nombre, precio) {
        let carrito = obtenerCarrito();
        const existe = carrito.find((p) => p.id === id);

        if (existe) existe.cantidad++;
        else carrito.push({ id, nombre, precio, cantidad: 1 });

        guardarCarrito(carrito);
      }

      function wireBotonesCarrito(selector) {
        document.querySelectorAll(selector).forEach((btn) => {
          btn.addEventListener("click", () => {
            const card = btn.closest("[data-id]");
            if (!card) return;

            agregarAlCarrito(
              card.dataset.id,
              card.dataset.nombre,
              parseFloat(card.dataset.precio)
            );
            alert("Producto agregado al carrito");
          });
        });
      }

      // ‚úÖ Ir a detalle al hacer click en la card (excepto en el bot√≥n)
      function wireIrDetalle(selectorCards) {
        document.querySelectorAll(selectorCards).forEach((card) => {
          card.addEventListener("click", (e) => {
            if (e.target.closest("button")) return;
            const id = card.dataset.id;
            const base = getBasePath();
            window.location.href = `${base}/View/pages/producto.html?id=${encodeURIComponent(id)}`;
          });
        });
      }

      /* ‚úÖ BasePath din√°mico (funciona en ra√≠z o subcarpeta) */
      function getBasePath() {
        return window.PROJECT_BASE || "";
      }

      /* ‚úÖ Funci√≥n real de b√∫squeda */
      function realizarBusqueda() {
        const input = document.getElementById("buscador");
        if (!input) return;

        const valor = input.value.trim();
        if (!valor) return;

        const base = getBasePath();
        window.location.href = `${base}/View/pages/busqueda.html?q=${encodeURIComponent(valor)}`;
      }

      /* ‚úÖ IMPORTANT√çSIMO: el header llama a realizarBusquedaGlobal() */
      function realizarBusquedaGlobal() {
        realizarBusqueda();
      }

      function irPromociones() {
        const seccion = document.getElementById("promociones");
        if (seccion) seccion.scrollIntoView({ behavior: "smooth" });
      }



function crearCardMasVendido(prod) {
  const col = document.createElement("div");
  col.className = "col-12 col-sm-6 col-md-4 col-lg-3";

  const imagen = resolverImagen(prod.imagen);

  col.innerHTML = `
    <div class="card card-oferta position-relative h-100">


      <!-- Imagen -->
      <div class="oferta-img">
        <img src="${imagen}" alt="${prod.nombre}">
      </div>

      <!-- Info -->
      <div class="oferta-body">
        <h6 class="oferta-titulo">
          ${prod.nombre}
        </h6>

        <div class="oferta-precios">
          <span class="precio-oferta">
            ${formatearDinero(prod.precio)}
          </span>
        </div>

        <small class="text-muted">M√°s vendido</small>
      </div>

      <!-- Bot√≥n (NO flotante, m√°s sobrio) -->
<a href="/View/pages/producto.html?id=${prod.id}"
   class="btn btn-mega-yellow btn-sm w-100 mt-2 rounded-pill">
  Ver producto
</a>


    </div>
  `;

  return col;
}







async function cargarMasVendidos() {
  const contenedor = document.getElementById("gridMasVendidos");
  if (!contenedor) return;

  contenedor.innerHTML = "<p>Cargando productos...</p>";

  try {
    const resp = await fetch(
      "/Controller/reportesController.php?accion=productosMasVendidosPublicos&limit=4"
    );

    const data = await resp.json();

    if (!data.length) {
      contenedor.innerHTML = "<p>No hay productos m√°s vendidos.</p>";
      return;
    }

    contenedor.innerHTML = "";

    data.forEach(prod => {
      contenedor.appendChild(crearCardMasVendido(prod));
    });

  } catch (e) {
    console.error("Error cargando m√°s vendidos", e);
    contenedor.innerHTML = "<p>Error al cargar productos.</p>";
  }
}

function crearCardOferta(prod) {
  const precioBase = parseFloat(prod.precio);
  const precioOferta = parseFloat(prod.precio_oferta);

  if (!precioOferta || precioOferta >= precioBase) return "";

  const descuento = Math.round((1 - precioOferta / precioBase) * 100);
  const imagen = resolverImagen(prod.imagen);

  return `
<div class="col-12 col-sm-6 col-md-4 col-lg-3">
  <div class="card card-oferta position-relative h-100" data-id="${prod.id}">

    <!-- Badge descuento -->
    <span class="badge-descuento">
      -${descuento}%
    </span>

    <!-- Imagen -->
    <div class="oferta-img">
      <img src="${imagen}" alt="${prod.nombre}">
    </div>

    <!-- Info -->
    <div class="oferta-body">
      <h6 class="oferta-titulo">
        ${prod.nombre}
      </h6>

      <div class="oferta-precios">
        <span class="precio-antiguo">
          ${formatearDinero(precioBase)}
        </span>
        <span class="precio-oferta">
          ${formatearDinero(precioOferta)}
        </span>
      </div>

      <small class="text-muted">(Unds.)</small>
    </div>

    <!-- Bot√≥n flotante -->
    <button class="btn-mas btn-add"
            data-id="${prod.id}"
            data-nombre="${prod.nombre}"
            data-precio="${precioOferta}">
      +
    </button>

  </div>
</div>


  `;
}



async function cargarPromociones() {
  if (promocionesCargadas) return;
  promocionesCargadas = true;

  const cont = document.getElementById("gridPromos");
  if (!cont) return;

  try {
    const resp = await fetch(`${API_URL}?accion=ofertas&limit=8`);
    const data = await resp.json();

    if (!Array.isArray(data) || data.length === 0) {
      cont.innerHTML = "<p>No hay ofertas disponibles.</p>";
      return;
    }

    cont.innerHTML = data.map(crearCardOferta).join("");

    wireBotonesCarrito("#gridPromos .btn-add");
    wireIrDetalle("#gridPromos .card-oferta");

if (!carruselOfertasActivo) {
  requestAnimationFrame(() => {
  iniciarCarruselPresentacional();
});

}


  } catch (err) {
    console.error(err);
    cont.innerHTML = "<p>Error al cargar las ofertas.</p>";
  }
}



      function initIndexPage() {
  const buscador = document.getElementById("buscador");
  if (buscador) {
    buscador.addEventListener("keyup", (e) => {
      if (e.key === "Enter") realizarBusqueda();
    });
  }

  cargarMasVendidos();
  cargarPromociones(); // esta ser√° tu √öNICA secci√≥n de ofertas
}

    </script>

    <!-- LAYOUT -->
    <script src="/View/assets/js/layout-loader.js"></script>
      

<script>
fetch("/promociones/publicas")
.then(r => r.json())
.then(data => {
  if (!data.length) return;

  let index = 0;
  const total = data.length;

  const prevImg = document.getElementById("promoPrev");
  const activeImg = document.getElementById("promoActive");
  const nextImg = document.getElementById("promoNext");

  const prevBtn = document.getElementById("promoPrevBtn");
  const nextBtn = document.getElementById("promoNextBtn");
  const dotsCont = document.getElementById("promoDots");

  // Crear dots
  dotsCont.innerHTML = "";
  data.forEach((_, i) => {
    const dot = document.createElement("span");
    dot.addEventListener("click", () => {
      index = i;
      render();
    });
    dotsCont.appendChild(dot);
  });

    
    
  function render() {
  // Quitar clases (fade out)
  activeImg.classList.remove("active");
  prevImg.classList.remove("side");
  nextImg.classList.remove("side");

  // Espera a que termine la animaci√≥n
  setTimeout(() => {
    prevImg.src   = data[(index - 1 + total) % total].imagen_banner;
    activeImg.src = data[index].imagen_banner;
    nextImg.src   = data[(index + 1) % total].imagen_banner;

    // Forzar reflow (truco para animaci√≥n limpia)
    void activeImg.offsetWidth;

    // Volver a aplicar clases (fade in)
    activeImg.classList.add("active");
    prevImg.classList.add("side");
    nextImg.classList.add("side");

    [...dotsCont.children].forEach((d, i) =>
      d.classList.toggle("active", i === index)
    );
  }, 150); // üëà este delay es el ‚Äúsmooth‚Äù
}


  prevBtn.addEventListener("click", () => {
    index = (index - 1 + total) % total;
    render();
  });

  nextBtn.addEventListener("click", () => {
    index = (index + 1) % total;
    render();
  });

  render();

  // ===== SWIPE PARA M√ìVIL (BANNER PRINCIPAL) =====
  const promoArea = document.getElementById("promoPreview");

  if (promoArea) {
    enableSwipe(
      promoArea,
      () => {
        index = (index + 1) % total;
        render();
      },
      () => {
        index = (index - 1 + total) % total;
        render();
      }
    );
  }

  // Auto-play suave
  setInterval(() => {
    index = (index + 1) % total;
    render();
  }, 6000);
});

</script>



    <script>
      loadLayout().then(() => {
        initIndexPage();

        // ‚úÖ Cargar sesi√≥n usuario DESPU√âS del layout
        const s = document.createElement("script");
        s.src = "View/assets/js/sesion-usuario.js";
        document.body.appendChild(s);
      });
    </script>
      
      <script src="/View/assets/js/swipe.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

      
      
      
<script>
function iniciarCarruselPresentacional() {
  if (carruselOfertasActivo) return;

  const cont = document.getElementById("gridPromos");
  if (!cont) return;

  const cards = Array.from(cont.children);
  const total = cards.length;

  if (total < 3) return;

  // üëá SOLO AQU√ç se marca como activo
  carruselOfertasActivo = true;

  const prevBtn = document.getElementById("ofertasPrevBtn");
  const nextBtn = document.getElementById("ofertasNextBtn");
  const dotsCont = document.getElementById("ofertasDots");

  // üö´ MENOS DE 3 ‚Üí SIN CARRUSEL
  if (total < 3) {
    cards.forEach(card => {
      card.classList.remove("left", "center", "right");
      card.style.position = "relative";
      card.style.transform = "none";
    });

    cont.style.display = "flex";
    cont.style.justifyContent = "center";
    cont.style.gap = "32px";

    if (prevBtn) prevBtn.style.display = "none";
    if (nextBtn) nextBtn.style.display = "none";
    if (dotsCont) dotsCont.innerHTML = "";

    return;
  }

  // ======================
  // CARRUSEL NORMAL (>= 3)
  // ======================
  let index = 0;
  let interval = null;

  // ===== DOTS (igual que banner) =====
  dotsCont.innerHTML = "";
  cards.forEach((_, i) => {
    const dot = document.createElement("span");
    dot.addEventListener("click", () => {
      index = i;
      render();
      resetAuto();
    });
    dotsCont.appendChild(dot);
  });

  function render() {
    cards.forEach((card, i) => {
      card.classList.remove("left", "center", "right");

      if (i === index) {
        card.classList.add("center");
      }
      else if (i === (index + 1) % total) {
        card.classList.add("right");
      }
      else if (i === (index - 1 + total) % total) {
        card.classList.add("left");
      }
    });

    [...dotsCont.children].forEach((d, i) =>
      d.classList.toggle("active", i === index)
    );
  }

function next() {
  index = (index + 1) % total;
  render();
}

function prev() {
  index = (index - 1 + total) % total;
  render();
}


function startAuto() {
  clearInterval(interval);
  interval = setInterval(next, 3500);
}


  function stopAuto() {
    clearInterval(interval);
  }

  function resetAuto() {
    stopAuto();
    startAuto();
  }

  // ===== FLECHAS (IGUALES AL BANNER) =====
  nextBtn?.addEventListener("click", () => {
    next();
    resetAuto();
  });

  prevBtn?.addEventListener("click", () => {
    prev();
    resetAuto();
  });
    
    
  // ===== PAUSA AL HOVER =====
  cont.addEventListener("mouseenter", stopAuto);
  cont.addEventListener("mouseleave", startAuto);

  // ===== SWIPE PARA M√ìVIL (OFERTAS) =====
  enableSwipe(
    cont,
    () => {
      next();
      resetAuto();
    },
    () => {
      prev();
      resetAuto();
    }
  );

  render();
  startAuto();
}

</script>















      
      
  </body>
</html>
